# Extended endpoints for SPM/PPM system
# This file contains additional endpoints that complement server.py

from fastapi import APIRouter, Depends, HTTPException, File, UploadFile
from motor.motor_asyncio import AsyncIOMotorClient\nfrom models import *\nfrom utils.security import encrypt_sensitive_data\nfrom utils.validators import validate_credit_distribution, calculate_sla_hours, check_sla_breach\nfrom decimal import Decimal\nfrom datetime import datetime, timezone\nimport os\n\nmongo_url = os.environ['MONGO_URL']\nclient = AsyncIOMotorClient(mongo_url)\ndb = client[os.environ['DB_NAME']]\n\n# These endpoints would be included in main server.py\n# Showing additional Phase 2-5 endpoints\n\n# ============= CREDIT ASSIGNMENT ENDPOINTS =============\n\nasync def create_credit_assignment_endpoint(assignment_data: CreditAssignmentCreate, current_user: User):\n    # Validate 100% distribution\n    if not validate_credit_distribution(assignment_data.assignments):\n        raise HTTPException(status_code=400, detail=\"Credit distribution must equal 100%\")\n    \n    assignment = CreditAssignment(**assignment_data.model_dump())\n    doc = assignment.model_dump()\n    doc['created_at'] = doc['created_at'].isoformat()\n    doc['total_credit_percent'] = str(doc['total_credit_percent'])\n    \n    await db.credit_assignments.insert_one(doc)\n    return assignment\n\n# ============= SPIFF ENDPOINTS =============\n\nasync def create_spiff_endpoint(spiff_data: SpiffCreate, current_user: User):\n    spiff = Spiff(**spiff_data.model_dump(), created_by=current_user.id)\n    doc = spiff.model_dump()\n    doc['start_date'] = doc['start_date'].isoformat()\n    doc['end_date'] = doc['end_date'].isoformat()\n    doc['created_at'] = doc['created_at'].isoformat()\n    doc['incentive_amount'] = str(doc['incentive_amount'])\n    \n    await db.spiffs.insert_one(doc)\n    return spiff\n\n# ============= PARTNER ENDPOINTS =============\n\nasync def create_partner_endpoint(partner_data: PartnerCreate):\n    partner = Partner(**partner_data.model_dump())\n    doc = partner.model_dump()\n    doc['created_at'] = doc['created_at'].isoformat()\n    doc['updated_at'] = doc['updated_at'].isoformat()\n    \n    await db.partners.insert_one(doc)\n    return partner\n\nasync def get_my_partner_info(current_user: User):\n    partner = await db.partners.find_one({\"user_id\": current_user.id}, {\"_id\": 0})\n    if not partner:\n        raise HTTPException(status_code=404, detail=\"Partner profile not found\")\n    \n    for key in ['created_at', 'updated_at']:\n        if isinstance(partner[key], str):\n            partner[key] = datetime.fromisoformat(partner[key])\n    \n    return partner\n\n# ============= APPROVAL WORKFLOW ENDPOINTS =============\n\nasync def create_approval_workflow_endpoint(workflow_data: ApprovalWorkflowCreate, current_user: User):\n    workflow = ApprovalWorkflow(**workflow_data.model_dump(), initiated_by=current_user.id)\n    doc = workflow.model_dump()\n    doc['created_at'] = doc['created_at'].isoformat()\n    doc['updated_at'] = doc['updated_at'].isoformat()\n    \n    await db.approval_workflows.insert_one(doc)\n    return workflow\n\nasync def approve_workflow_step(workflow_id: str, step_number: int, current_user: User, comments: Optional[str] = None):\n    workflow = await db.approval_workflows.find_one({\"id\": workflow_id}, {\"_id\": 0})\n    if not workflow:\n        raise HTTPException(status_code=404, detail=\"Workflow not found\")\n    \n    # Find the step\n    for step in workflow['steps']:\n        if step['step_number'] == step_number and step['approver_id'] == current_user.id:\n            step['status'] = 'approved'\n            step['timestamp'] = datetime.now(timezone.utc).isoformat()\n            step['comments'] = comments\n            break\n    \n    # Update workflow status\n    all_approved = all(s['status'] == 'approved' for s in workflow['steps'])\n    if all_approved:\n        workflow['status'] = 'final_approved'\n    \n    await db.approval_workflows.update_one(\n        {\"id\": workflow_id},\n        {\"$set\": {\"steps\": workflow['steps'], \"status\": workflow['status'], \"updated_at\": datetime.now(timezone.utc).isoformat()}}\n    )\n    \n    return {\"message\": \"Step approved\", \"workflow_status\": workflow['status']}\n\n# ============= PAYOUT ENDPOINTS =============\n\nasync def create_payout_endpoint(payout_data: PayoutCreate, current_user: User):\n    # Calculate commission totals for period\n    calculations = await db.commission_calculations.find({\n        \"sales_rep_id\": payout_data.user_id,\n        \"calculation_date\": {\n            \"$gte\": payout_data.payout_period_start.isoformat(),\n            \"$lte\": payout_data.payout_period_end.isoformat()\n        },\n        \"status\": \"approved\"\n    }, {\"_id\": 0}).to_list(1000)\n    \n    total_commission = sum(Decimal(c['final_amount']) for c in calculations)\n    \n    payout = Payout(\n        **payout_data.model_dump(),\n        total_commission=total_commission,\n        net_payout=total_commission  # After adjustments/deductions\n    )\n    \n    doc = payout.model_dump()\n    doc['payout_period_start'] = doc['payout_period_start'].isoformat()\n    doc['payout_period_end'] = doc['payout_period_end'].isoformat()\n    doc['created_at'] = doc['created_at'].isoformat()\n    for key in ['total_commission', 'adjustments', 'deductions', 'net_payout']:\n        doc[key] = str(doc[key])\n    \n    await db.payouts.insert_one(doc)\n    return payout\n\n# ============= TERRITORY ENDPOINTS =============\n\nasync def create_territory_endpoint(territory_data: TerritoryCreate, current_user: User):\n    territory = Territory(**territory_data.model_dump())\n    doc = territory.model_dump()\n    doc['created_at'] = doc['created_at'].isoformat()\n    doc['updated_at'] = doc['updated_at'].isoformat()\n    doc['account_potential'] = str(doc['account_potential'])\n    \n    await db.territories.insert_one(doc)\n    return territory\n\n# ============= QUOTA ENDPOINTS =============\n\nasync def create_quota_endpoint(quota_data: QuotaCreate, current_user: User):\n    quota = Quota(**quota_data.model_dump())\n    doc = quota.model_dump()\n    doc['period_start'] = doc['period_start'].isoformat()\n    doc['period_end'] = doc['period_end'].isoformat()\n    doc['created_at'] = doc['created_at'].isoformat()\n    doc['updated_at'] = doc['updated_at'].isoformat()\n    for key in ['quota_amount', 'current_attainment', 'attainment_percent']:\n        doc[key] = str(doc[key])\n    \n    await db.quotas.insert_one(doc)\n    return quota\n\n# ============= FORECAST ENDPOINTS =============\n\nasync def create_forecast_endpoint(forecast_data: ForecastCreate, current_user: User):\n    # Simplified forecast calculation\n    forecast = Forecast(\n        **forecast_data.model_dump(),\n        created_by=current_user.id,\n        projected_revenue=Decimal(\"1000000.0000\"),\n        projected_payout=Decimal(\"50000.0000\"),\n        projected_cos_percent=Decimal(\"5.0000\")\n    )\n    \n    doc = forecast.model_dump()\n    doc['period_start'] = doc['period_start'].isoformat()\n    doc['period_end'] = doc['period_end'].isoformat()\n    doc['created_at'] = doc['created_at'].isoformat()\n    for key in ['projected_revenue', 'projected_payout', 'projected_cos_percent', 'variance_from_current']:\n        doc[key] = str(doc[key])\n    \n    await db.forecasts.insert_one(doc)\n    return forecast\n\n# ============= TICKET ENDPOINTS =============\n\nasync def create_ticket_endpoint(ticket_data: TicketCreate, current_user: User):\n    sla_hours = calculate_sla_hours(ticket_data.severity)\n    \n    ticket = Ticket(**ticket_data.model_dump(), submitted_by=current_user.id, sla_hours=sla_hours)\n    doc = ticket.model_dump()\n    doc['created_at'] = doc['created_at'].isoformat()\n    \n    await db.tickets.insert_one(doc)\n    return ticket\n\nasync def get_my_tickets(current_user: User):\n    tickets = await db.tickets.find({\"submitted_by\": current_user.id}, {\"_id\": 0}).to_list(100)\n    for t in tickets:\n        t['created_at'] = datetime.fromisoformat(t['created_at'])\n        if t.get('resolved_at'):\n            t['resolved_at'] = datetime.fromisoformat(t['resolved_at'])\n        # Check SLA breach\n        t['sla_breach'] = check_sla_breach(t['created_at'], t['sla_hours'])\n    return tickets\n\n# ============= NFM ENDPOINTS =============\n\nasync def create_nfm_endpoint(nfm_data: NFMCreate, current_user: User):\n    nfm = NFM(**nfm_data.model_dump())\n    doc = nfm.model_dump()\n    doc['created_at'] = doc['created_at'].isoformat()\n    for key in ['target_value', 'actual_value']:\n        doc[key] = str(doc[key])\n    if doc.get('multiplier_effect'):\n        doc['multiplier_effect'] = str(doc['multiplier_effect'])\n    if doc.get('threshold_requirement'):\n        doc['threshold_requirement'] = str(doc['threshold_requirement'])\n    \n    await db.nfms.insert_one(doc)\n    return nfm\n